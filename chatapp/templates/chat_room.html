<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ChatApp">
  <meta name="description" content="Chat – {{ room_name }}">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
  <title>Chat – {{ room_name }}</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased
    }

    audio {
      position: absolute;
      left: -9999px;
      opacity: 0
    }

    ::-webkit-scrollbar {
      width: 0;
      height: 0
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(12px) scale(.97)
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1)
      }
    }

    .message-animation {
      animation: fadeIn .3s cubic-bezier(.25, .46, .45, .94)
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(.95);
        opacity: .8
      }

      100% {
        transform: scale(1.15);
        opacity: 0
      }
    }

    .pulse-ring {
      animation: pulse-ring 2s infinite
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1
      }

      50% {
        transform: scale(1.08);
        opacity: .7
      }
    }

    .recording-pulse {
      animation: pulse 1.5s infinite
    }

    .file-preview {
      transition: all .2s
    }

    .file-preview:hover {
      transform: translateY(-2px)
    }

    .dropdown-menu {
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all .2s ease
    }

    .dropdown-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0)
    }

    /* iMessage bubble styles */
    .bubble-sent {
      background: #007AFF;
      color: #fff;
      border-radius: 18px 18px 4px 18px;
      padding: 9px 14px;
      font-size: 16px;
      line-height: 1.38;
      word-wrap: break-word
    }

    .bubble-received {
      background: #1C1C1E;
      color: #fff;
      border-radius: 18px 18px 18px 4px;
      padding: 9px 14px;
      font-size: 16px;
      line-height: 1.38;
      word-wrap: break-word
    }

    .bubble-sent a,
    .bubble-received a {
      color: inherit;
      text-decoration: underline
    }

    /* iOS-style input */
    .imsg-input {
      width: 100%;
      padding: 10px 16px;
      background: #1C1C1E;
      border: 1px solid #2C2C2E;
      border-radius: 20px;
      color: #fff;
      font-size: 16px;
      font-family: inherit;
      outline: none;
      -webkit-appearance: none
    }

    .imsg-input:focus {
      border-color: #3A3A3C
    }

    .imsg-input::placeholder {
      color: #636366
    }

    /* Send button */
    .send-circle {
      width: 32px;
      height: 32px;
      background: #007AFF;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform .15s
    }

    .send-circle:active {
      transform: scale(.88)
    }

    .send-circle svg {
      width: 16px;
      height: 16px;
      color: #fff;
      transform: rotate(45deg);
      margin-left: 1px
    }

    /* Typing indicator */
    .typing-indicator {
      display: none;
      padding: 4px 0 4px 4px;
    }

    .typing-indicator.active {
      display: flex;
    }

    .typing-dots {
      display: flex;
      align-items: center;
      gap: 3px;
      background: #1C1C1E;
      border-radius: 18px 18px 18px 4px;
      padding: 10px 14px;
    }

    .typing-dots span {
      width: 7px;
      height: 7px;
      background: #8E8E93;
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingBounce {

      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: 0.4;
      }

      30% {
        transform: translateY(-4px);
        opacity: 1;
      }
    }

    /* Reconnection banner */
    .reconnect-banner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #1C1C1E;
      color: #FF9F0A;
      text-align: center;
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 500;
      z-index: 100;
      border-bottom: 1px solid #2C2C2E;
    }

    .reconnect-banner.active {
      display: block;
    }

    /* New messages button */
    .new-messages-btn {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #007AFF;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      z-index: 25;
      font-family: inherit;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
      transition: transform 0.15s;
    }

    .new-messages-btn:active {
      transform: translateX(-50%) scale(0.95);
    }

    .new-messages-btn.active {
      display: block;
    }

    /* Drop zone overlay */
    .drop-zone {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 122, 255, 0.08);
      border: 3px dashed #007AFF;
      z-index: 60;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .drop-zone.active {
      display: flex;
    }

    .drop-zone-text {
      background: #1C1C1E;
      border-radius: 16px;
      padding: 20px 32px;
      color: #007AFF;
      font-size: 16px;
      font-weight: 600;
      border: 1px solid #2C2C2E;
    }

    /* Date divider */
    .date-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0 8px;
    }

    .date-divider::before,
    .date-divider::after {
      content: '';
      flex: 1;
      height: 0.5px;
      background: #2C2C2E;
    }

    .date-divider span {
      font-size: 11px;
      color: #8E8E93;
      font-weight: 500;
      white-space: nowrap;
    }

    /* Emoji picker */
    .emoji-picker {
      display: none;
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 8px;
      background: #1C1C1E;
      border-radius: 16px;
      border: 1px solid #2C2C2E;
      padding: 12px;
      width: 320px;
      max-height: 280px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      z-index: 30;
    }

    .emoji-picker.active {
      display: block;
    }

    .emoji-tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 8px;
      border-bottom: 1px solid #2C2C2E;
      padding-bottom: 8px;
    }

    .emoji-tab {
      flex: 1;
      background: none;
      border: none;
      padding: 4px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s;
    }

    .emoji-tab:hover,
    .emoji-tab.active {
      background: #2C2C2E;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 2px;
      max-height: 200px;
      overflow-y: auto;
    }

    .emoji-grid button {
      background: none;
      border: none;
      font-size: 22px;
      padding: 4px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s;
      line-height: 1;
    }

    .emoji-grid button:hover {
      background: #2C2C2E;
    }

    /* Search bar */
    .search-bar {
      display: none;
      position: sticky;
      top: 0;
      z-index: 19;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      padding: 8px 16px;
      border-bottom: 0.5px solid #2C2C2E;
    }

    .search-bar.active {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-bar input {
      flex: 1;
      background: #1C1C1E;
      border: 1px solid #2C2C2E;
      border-radius: 10px;
      padding: 8px 12px;
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      outline: none;
    }

    .search-bar input:focus {
      border-color: #3A3A3C;
    }

    .search-bar input::placeholder {
      color: #636366;
    }

    .search-match {
      background: rgba(0, 122, 255, 0.3) !important;
      border-radius: 3px;
    }

    .search-nav {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .search-nav button {
      background: none;
      border: none;
      color: #007AFF;
      cursor: pointer;
      padding: 4px;
      font-size: 18px;
    }

    .search-nav span {
      color: #8E8E93;
      font-size: 12px;
      white-space: nowrap;
    }

    /* Reply bar */
    .reply-bar {
      display: none;
      background: #1C1C1E;
      border-left: 3px solid #007AFF;
      padding: 6px 12px;
      margin: 0 12px 4px;
      border-radius: 0 8px 8px 0;
      align-items: center;
      gap: 8px;
    }

    .reply-bar.active {
      display: flex;
    }

    .reply-bar .reply-content {
      flex: 1;
      min-width: 0;
    }

    .reply-bar .reply-user {
      font-size: 12px;
      color: #007AFF;
      font-weight: 600;
    }

    .reply-bar .reply-text {
      font-size: 13px;
      color: #8E8E93;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .reply-bar .reply-close {
      background: none;
      border: none;
      color: #636366;
      cursor: pointer;
      padding: 4px;
    }

    /* Reply quote inside bubble */
    .reply-quote {
      background: rgba(255, 255, 255, 0.06);
      border-left: 2px solid #007AFF;
      border-radius: 0 6px 6px 0;
      padding: 4px 8px;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .reply-quote .rq-user {
      color: #007AFF;
      font-weight: 600;
      font-size: 11px;
    }

    .reply-quote .rq-text {
      color: #8E8E93;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    /* Message context menu (edit/delete) */
    .msg-actions {
      display: none;
      position: absolute;
      top: -32px;
      right: 0;
      background: #1C1C1E;
      border: 1px solid #2C2C2E;
      border-radius: 10px;
      padding: 4px;
      gap: 2px;
      z-index: 10;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
    }

    .msg-actions.left {
      right: auto;
      left: 0;
    }

    .msg-bubble-wrap:hover .msg-actions {
      display: flex;
    }

    .msg-actions button {
      background: none;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 12px;
      color: #8E8E93;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      transition: background 0.15s;
    }

    .msg-actions button:hover {
      background: #2C2C2E;
      color: #fff;
    }

    .msg-actions .delete-btn:hover {
      color: #FF453A;
    }

    .msg-deleted {
      font-style: italic;
      color: #636366 !important;
      opacity: 0.6;
    }

    .msg-edited-tag {
      font-size: 10px;
      color: #636366;
      font-style: italic;
    }
  </style>
</head>

<body class="bg-black text-white" style="height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden">

  <!-- RECONNECTION BANNER -->
  <div id="reconnect-banner" class="reconnect-banner">Reconnecting…</div>

  <!-- HEADER -->
  <!-- HEADER (iMessage style) -->
  <header
    style="position:sticky;top:0;z-index:20;background:rgba(0,0,0,0.85);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);border-bottom:0.5px solid #2C2C2E;padding:10px 16px;padding-top:max(10px,env(safe-area-inset-top))">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <!-- Left: Room info -->
      <div style="display:flex;align-items:center;gap:10px">
        <div style="position:relative">
          <div
            style="width:38px;height:38px;background:linear-gradient(135deg,#007AFF,#5856D6);border-radius:50%;display:flex;align-items:center;justify-content:center">
            <span style="color:#fff;font-weight:700;font-size:16px">#</span>
          </div>
          <div
            style="position:absolute;bottom:0;right:0;width:10px;height:10px;background:#30D158;border-radius:50%;border:2px solid #000">
          </div>
        </div>
        <div>
          <h1 style="font-size:17px;font-weight:600;color:#fff;line-height:1.2">{{ room_name }}</h1>
          <p id="online-count" style="font-size:12px;color:#8E8E93;margin-top:1px">Loading...</p>
        </div>
      </div>

      <!-- Right: Actions -->
      <div style="display:flex;align-items:center;gap:6px">
        <!-- Call -->
        <button id="call-icon"
          style="width:36px;height:36px;border-radius:50%;background:transparent;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#007AFF"
          title="Call">
          <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
        </button>
        <!-- Search -->
        <button id="search-icon"
          style="width:36px;height:36px;border-radius:50%;background:transparent;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#007AFF"
          title="Search">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
        <!-- Menu -->
        <div style="position:relative">
          <button id="header-menu-btn"
            style="width:36px;height:36px;border-radius:50%;background:transparent;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#007AFF"
            title="Menu">
            <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="5" r="1.5" fill="currentColor" />
              <circle cx="12" cy="12" r="1.5" fill="currentColor" />
              <circle cx="12" cy="19" r="1.5" fill="currentColor" />
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div id="header-dropdown"
            class="dropdown-menu absolute right-0 top-full mt-2 bg-gray-900 rounded-xl shadow-2xl border border-gray-800 py-1.5 min-w-[180px] z-50">
            <!-- User info -->
            <div class="px-4 py-2.5 border-b border-gray-800">
              <div class="flex items-center space-x-2.5">
                <div
                  class="w-8 h-8 bg-gradient-to-r from-gray-700 to-gray-800 rounded-full flex items-center justify-center border border-gray-600">
                  <span class="text-gray-300 font-bold text-sm">{{ request.user.username|first|upper }}</span>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-200">{{ request.user.username }}</p>
                  <p class="text-[11px] text-gray-500">{% if request.user.is_staff %}Admin{% else %}Member{% endif %}
                  </p>
                </div>
              </div>
            </div>

            {% if request.user.is_staff %}
            <a href="/panel/create-user/"
              class="flex items-center space-x-2.5 px-4 py-2.5 hover:bg-gray-800 transition-colors">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span class="text-sm text-gray-300">Admin Dashboard</span>
            </a>
            <a href="/admin/" class="flex items-center space-x-2.5 px-4 py-2.5 hover:bg-gray-800 transition-colors">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              <span class="text-sm text-gray-300">Django Admin</span>
            </a>
            {% endif %}

            <div class="border-t border-gray-800 mt-1 pt-1">
              <a href="/logout/" class="flex items-center space-x-2.5 px-4 py-2.5 hover:bg-gray-800 transition-colors">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span class="text-sm text-gray-300">Logout</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


  <!-- SELECT USER POPUP -->
  <div id="call-user-popup"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-40 p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-800">
      <div class="p-6 border-b border-gray-800">
        <div class="flex items-center space-x-3">
          <div class="p-2 rounded-lg bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700">
            <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white">Start a Call</h3>
        </div>
        <p class="text-gray-400 mt-2">Select a user to call</p>
      </div>

      <div class="p-4 max-h-96 overflow-y-auto">
        <ul id="user-list" class="space-y-2"></ul>
      </div>

      <div class="p-4 border-t border-gray-800">
        <button onclick="closeUserPopup()"
          class="w-full px-4 py-3 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-xl font-medium transition-colors border border-gray-700">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- INCOMING CALL POPUP -->
  <div id="incoming-call-popup"
    class="fixed inset-0 bg-black/90 backdrop-blur-md hidden items-center justify-center z-50 p-4">
    <div
      class="bg-gradient-to-br from-gray-900 to-black rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-800">
      <div class="p-8 text-center">
        <div class="relative mx-auto w-24 h-24 mb-6">
          <div class="absolute inset-0 bg-gradient-to-r from-gray-600 to-gray-700 rounded-full pulse-ring"></div>
          <div
            class="relative w-full h-full bg-gradient-to-r from-gray-700 to-gray-800 rounded-full flex items-center justify-center border border-gray-600">
            <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
        </div>

        <h3 id="caller-name" class="text-2xl font-bold text-white mb-2"></h3>
        <p class="text-gray-400 mb-8">is calling you...</p>

        <div class="flex space-x-4">
          <button id="reject-call"
            class="flex-1 px-6 py-4 bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl font-semibold shadow-lg border border-gray-700 transition-all active:scale-95 flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            <span>Decline</span>
          </button>

          <button id="accept-call"
            class="flex-1 px-6 py-4 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white rounded-xl font-semibold shadow-lg border border-gray-600 transition-all active:scale-95 flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Accept</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- CHAT MESSAGES CONTAINER -->
  <main id="messages" style="flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:4px">
    {% for m in messages %}
    <div class="message-animation" data-msg-id="{{ m.id }}" data-username="{{ m.user.username }}"
      data-text="{{ m.content|default:'' }}"
      style="display:flex;{% if m.user.username == request.user.username %}justify-content:flex-end{% else %}justify-content:flex-start{% endif %}">
      <div style="max-width:78%;position:relative" class="msg-bubble-wrap">
        {% if m.user.username != request.user.username %}
        <p style="font-size:11px;color:#8E8E93;margin-bottom:2px;margin-left:4px">{{ m.user.username }}</p>
        {% endif %}
        <div class="{% if m.user.username == request.user.username %}bubble-sent{% else %}bubble-received{% endif %}">
          {% if m.content %}<p>{{ m.content }}</p>{% endif %}
          {% if m.attachments_json %}
          {% for attachment in m.attachments_json %}
          {% if attachment.type == 'image' %}
          <div style="margin-top:6px;border-radius:12px;overflow:hidden;cursor:pointer"
            onclick="openImagePreview('{{ attachment.url }}', '{{ attachment.name }}')">
            <img src="{{ attachment.url }}" alt="Image" style="width:100%;max-width:280px;height:auto;display:block">
          </div>
          {% elif attachment.type == 'file' %}
          <div
            style="margin-top:6px;padding:8px 12px;background:rgba(255,255,255,0.08);border-radius:10px;display:flex;align-items:center;gap:8px;cursor:pointer"
            onclick="downloadFile('{{ attachment.url }}', '{{ attachment.name }}')">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <div>
              <p style="font-size:13px;opacity:0.9">{{ attachment.name }}</p>
              <p style="font-size:11px;opacity:0.6">{{ attachment.size }}</p>
            </div>
          </div>
          {% elif attachment.type == 'voice' %}
          <div style="margin-top:6px;display:flex;align-items:center;gap:8px">
            <button onclick="playVoiceNote('{{ attachment.url }}')"
              style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.15);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="color:#fff">
                <path d="M8 5v14l11-7z" />
              </svg>
            </button>
            <div style="flex:1">
              <div style="height:3px;background:rgba(255,255,255,0.2);border-radius:2px">
                <div class="voice-progress"
                  style="height:100%;background:rgba(255,255,255,0.6);width:0;border-radius:2px"></div>
              </div>
              <p style="font-size:11px;opacity:0.5;margin-top:3px">{{ attachment.duration }}</p>
            </div>
          </div>
          {% endif %}
          {% endfor %}
          {% endif %}
        </div>
        <div
          style="display:flex;align-items:center;gap:4px;margin-top:2px;{% if m.user.username == request.user.username %}justify-content:flex-end{% endif %};padding:0 4px">
          <p style="font-size:10px;color:#636366">{{ m.timestamp|time:"g:i A" }}</p>
          <button onclick="setReply('{{ m.user.username }}', '{{ m.content|escapejs }}')"
            style="background:none;border:none;cursor:pointer;padding:2px;opacity:0;transition:opacity 0.15s"
            class="reply-btn">
            <svg width="14" height="14" fill="none" stroke="#636366" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 10h10a5 5 0 015 5v6M3 10l6 6M3 10l6-6" />
            </svg>
          </button>
        </div>
        {% if m.user.username == request.user.username %}
        <div class="msg-actions">
          <button onclick="startEditMessage({{ m.id }}, this)" title="Edit">
            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit
          </button>
          <button class="delete-btn" onclick="deleteMessage({{ m.id }})" title="Delete">
            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
          </button>
        </div>
        {% else %}
        <div class="msg-actions left">
          <button onclick="setReply('{{ m.user.username }}', '{{ m.content|escapejs }}')" title="Reply">
            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 10h10a5 5 0 015 5v6M3 10l6 6M3 10l6-6" />
            </svg>
            Reply
          </button>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}

    <!-- TYPING INDICATOR -->
    <div id="typing-indicator" class="typing-indicator">
      <div style="max-width:78%">
        <p id="typing-username" style="font-size:11px;color:#8E8E93;margin-bottom:2px;margin-left:4px"></p>
        <div class="typing-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
  </main>

  <!-- NEW MESSAGES BUTTON -->
  <button id="new-messages-btn" class="new-messages-btn" onclick="scrollToBottom(true)">↓ New messages</button>

  <!-- DROP ZONE OVERLAY -->
  <div id="drop-zone" class="drop-zone">
    <div class="drop-zone-text">Drop files here</div>
  </div>

  <!-- MEDIA ATTACHMENTS PREVIEW -->
  <div id="media-preview" class="hidden px-4 pt-2 border-t border-gray-800 bg-black">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm text-gray-300">Attachments</span>
      <button onclick="clearMediaPreview()" class="text-gray-400 hover:text-gray-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="media-preview-content" class="flex space-x-2 overflow-x-auto pb-2"></div>
  </div>

  <!-- VOICE RECORDING UI -->
  <div id="voice-recording-ui"
    class="hidden fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-900 rounded-xl p-4 border border-gray-700 shadow-2xl z-40">
    <div class="flex items-center space-x-4">
      <div class="recording-pulse">
        <div
          class="w-10 h-10 bg-gradient-to-r from-gray-800 to-gray-900 rounded-full flex items-center justify-center border border-gray-600">
          <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
        </div>
      </div>
      <div>
        <p class="font-medium text-gray-300">Recording voice note...</p>
        <p id="recording-timer" class="text-sm text-gray-400">00:00</p>
      </div>
      <button id="stop-recording" class="ml-4 p-2 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700">
        <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- SEARCH BAR -->
  <div id="search-bar" class="search-bar">
    <input id="search-input" type="text" placeholder="Search messages...">
    <div class="search-nav">
      <span id="search-count"></span>
      <button type="button" onclick="searchNav(-1)">&uarr;</button>
      <button type="button" onclick="searchNav(1)">&darr;</button>
    </div>
    <button type="button" onclick="closeSearch()"
      style="background:none;border:none;color:#007AFF;cursor:pointer;font-size:14px;font-weight:600">Done</button>
  </div>

  <!-- REPLY PREVIEW BAR -->
  <div id="reply-bar" class="reply-bar">
    <div class="reply-content">
      <div class="reply-user" id="reply-bar-user"></div>
      <div class="reply-text" id="reply-bar-text"></div>
    </div>
    <button class="reply-close" onclick="cancelReply()">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- MESSAGE INPUT (iMessage style) -->
  <footer
    style="background:#000;border-top:0.5px solid #2C2C2E;padding:8px 12px;padding-bottom:max(8px,env(safe-area-inset-bottom));position:sticky;bottom:0;z-index:20">
    <form id="chat-form" style="display:flex;align-items:center;gap:8px">
      {% csrf_token %}

      <!-- + Attachment Button -->
      <div style="position:relative">
        <button type="button" id="attachment-btn"
          style="width:34px;height:34px;border-radius:50%;background:transparent;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#007AFF">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>

        <!-- Attachment Menu -->
        <div id="attachment-menu" class="hidden"
          style="position:absolute;bottom:100%;left:0;margin-bottom:8px;background:#1C1C1E;border-radius:14px;border:1px solid #2C2C2E;padding:6px;min-width:150px;box-shadow:0 8px 32px rgba(0,0,0,0.5)">
          <input type="file" id="file-upload" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.txt" multiple>
          <input type="file" id="camera-upload" class="hidden" accept="image/*" capture="environment">

          <button type="button" onclick="event.stopPropagation(); openCameraPreview()"
            style="width:100%;display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:none;background:transparent;cursor:pointer;color:#fff;font-size:14px;text-align:left">
            <svg width="18" height="18" fill="none" stroke="#007AFF" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Camera
          </button>

          <button type="button" onclick="event.stopPropagation(); document.getElementById('file-upload').click()"
            style="width:100%;display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:none;background:transparent;cursor:pointer;color:#fff;font-size:14px;text-align:left">
            <svg width="18" height="18" fill="none" stroke="#007AFF" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            File
          </button>

          <div style="height:0.5px;background:#2C2C2E;margin:4px 0"></div>

          <button type="button" id="voice-note-btn" onclick="event.stopPropagation(); startVoiceRecording()"
            style="width:100%;display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:none;background:transparent;cursor:pointer;color:#fff;font-size:14px;text-align:left">
            <svg width="18" height="18" fill="none" stroke="#007AFF" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            Voice Note
          </button>
        </div>
      </div>

      <!-- Message Input -->
      <div style="flex:1">
        <input id="message-input" type="text" placeholder="iMessage" class="imsg-input">
      </div>

      <!-- Emoji Button -->
      <div style="position:relative">
        <button type="button" id="emoji-btn"
          style="width:34px;height:34px;border-radius:50%;background:transparent;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px"
          title="Emoji">&#128512;</button>
        <div id="emoji-picker" class="emoji-picker">
          <div class="emoji-tabs" id="emoji-tabs"></div>
          <div class="emoji-grid" id="emoji-grid"></div>
        </div>
      </div>

      <!-- Send Button (circular blue) -->
      <button type="submit" class="send-circle">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
      </button>
    </form>
  </footer>

  <!-- ACTIVE CALL UI -->
  <div id="active-call-ui" class="fixed bottom-6 right-6 bg-gradient-to-br from-gray-900 to-black 
              border border-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-5 hidden z-40">

    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center space-x-3">
        <div class="relative">
          <div
            class="w-12 h-12 bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl flex items-center justify-center border border-gray-700">
            <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
          <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-gray-300 rounded-full border-2 border-black"></div>
        </div>
        <div>
          <h3 id="call-with" class="font-bold text-white">Call Connected</h3>
          <div class="flex items-center space-x-2">
            <span id="call-status" class="text-xs text-gray-300 font-medium">Connected</span>
            <span class="text-gray-600">•</span>
            <span id="call-timer" class="text-xs text-gray-400 font-mono">00:00</span>
          </div>
        </div>
      </div>

      <button id="minimize-call" class="p-2 hover:bg-gray-800 rounded-lg border border-gray-700">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14" />
        </svg>
      </button>
    </div>

    <div class="space-y-4">
      <!-- Audio Level Indicator -->
      <div class="flex items-center space-x-3">
        <div class="flex-1 bg-gray-800 h-2 rounded-full overflow-hidden border border-gray-700">
          <div id="audio-level" class="h-full bg-gradient-to-r from-gray-600 to-gray-700 w-1/2"></div>
        </div>
        <span class="text-xs text-gray-400">Audio Level</span>
      </div>

      <!-- Call Controls -->
      <div class="grid grid-cols-3 gap-3">
        <button id="mute-btn"
          class="p-3 bg-gray-800 hover:bg-gray-700 rounded-xl flex flex-col items-center justify-center space-y-1 transition-colors border border-gray-700">
          <svg id="mute-icon" class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
          <span class="text-xs text-gray-400">Mute</span>
        </button>

        <button id="speaker-btn"
          class="p-3 bg-gray-800 hover:bg-gray-700 rounded-xl flex flex-col items-center justify-center space-y-1 transition-colors border border-gray-700">
          <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
          </svg>
          <span class="text-xs text-gray-400">Speaker</span>
        </button>

        <button id="end-call-btn"
          class="p-3 bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl flex flex-col items-center justify-center space-y-1 transition-all border border-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          <span class="text-xs text-gray-300">End</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MINIMIZED CALL UI -->
  <div id="minimized-call-ui"
    class="fixed bottom-6 right-6 bg-gray-900 rounded-xl shadow-lg p-3 hidden z-30 border border-gray-800">
    <div class="flex items-center space-x-3">
      <div
        class="w-10 h-10 bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg flex items-center justify-center border border-gray-700">
        <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
        </svg>
      </div>
      <div class="min-w-0">
        <p class="text-sm font-medium text-white truncate" id="minimized-call-name"></p>
        <p class="text-xs text-gray-400" id="minimized-call-timer">00:00</p>
      </div>
      <button id="restore-call" class="p-2 hover:bg-gray-800 rounded-lg border border-gray-700">
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
        </svg>
      </button>
    </div>
  </div>

  <!-- CAMERA PREVIEW MODAL -->
  <div id="camera-preview-modal"
    class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="relative max-w-4xl max-h-full bg-gray-900 rounded-2xl overflow-hidden border border-gray-700">
      <div class="p-4 border-b border-gray-700 flex items-center justify-between">
        <h3 class="text-white font-medium">Take Photo</h3>
        <button onclick="closeCameraPreview()" class="text-gray-400 hover:text-gray-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="relative">
        <video id="camera-video" autoplay playsinline class="w-full max-h-96 object-cover"></video>
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-4">
          <button id="capture-btn"
            class="w-16 h-16 bg-white rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors shadow-lg">
            <div class="w-12 h-12 bg-gray-800 rounded-full border-4 border-white"></div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- IMAGE PREVIEW MODAL -->
  <div id="image-preview-modal"
    class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="relative max-w-4xl max-h-full">
      <img id="preview-image" src="" alt="Preview" class="max-w-full max-h-full object-contain">
      <button onclick="closeImagePreview()"
        class="absolute top-4 right-4 w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center hover:bg-gray-800 border border-gray-700">
        <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- FILE PREVIEW MODAL -->
  <div id="file-preview-modal"
    class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="relative max-w-4xl max-h-full bg-gray-900 rounded-lg overflow-hidden">
      <div class="p-4 border-b border-gray-700 flex items-center justify-between">
        <h3 id="file-preview-title" class="text-white font-medium">File Preview</h3>
        <button onclick="closeFilePreview()" class="text-gray-400 hover:text-gray-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-4">
        <iframe id="file-preview-iframe" src="" class="w-full h-96 border border-gray-700 rounded"></iframe>
      </div>
    </div>
  </div>

  <!-- AUDIO ELEMENTS -->
  <audio id="remoteAudio" autoplay></audio>
  <audio id="ringtone" loop>
    <source src="https://assets.mixkit.co/active_storage/sfx/268/268-preview.mp3" type="audio/mpeg">
  </audio>

  <script>
    /* ------------------------------
          GLOBAL VARIABLES
    ------------------------------ */

    const CURRENT_USER = "{{ request.user.username|escapejs }}";
    const roomName = "{{ room_name|escapejs }}";

    const socket = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") +
      location.host +
      "/ws/chat/" + roomName + "/"
    );

    let onlineUsers = new Set();
    let pc = null;
    let localStream = null;
    let callTarget = null;
    let ringTimeout = null;
    let callTimerInterval = null;
    let callSeconds = 0;
    let isCallMinimized = false;
    let audioContext = null;
    let analyser = null;
    let audioInterval = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordingTimerInterval = null;
    let recordingSeconds = 0;
    let attachments = [];

    // Phase 1: new state variables
    let typingTimeout = null;
    let typingDebounce = null;
    let newMessageCount = 0;
    let isUserNearBottom = true;
    let lastMessageDate = null;

    // Phase 2: state variables
    let replyToData = null; // {username, text}
    let searchMatches = [];
    let searchIndex = -1;

    const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    /* ------------------------------
          CHAT MESSAGE DISPLAY
    ------------------------------ */

    function displayChatMessage(username, message, isCurrentUser = false, attachments = [], replyTo = null, messageId = null) {
      const messagesContainer = document.getElementById("messages");
      const isMe = username === CURRENT_USER || isCurrentUser;

      const messageDiv = document.createElement("div");
      messageDiv.className = 'message-animation';
      messageDiv.style.cssText = `display:flex;${isMe ? 'justify-content:flex-end' : 'justify-content:flex-start'}`;
      messageDiv.setAttribute('data-username', username);
      messageDiv.setAttribute('data-text', message || '');
      if (messageId) messageDiv.setAttribute('data-msg-id', messageId);

      let attachmentsHTML = '';
      if (attachments && attachments.length > 0) {
        attachments.forEach(attachment => {
          if (attachment.type === 'image') {
            attachmentsHTML += `<div style="margin-top:6px;border-radius:12px;overflow:hidden;cursor:pointer" onclick="openImagePreview('${attachment.url}', '${attachment.name || 'image.jpg'}')"><img src="${attachment.url}" alt="${attachment.name || 'Image'}" style="width:100%;max-width:280px;height:auto;display:block"></div>`;
          } else if (attachment.type === 'file') {
            attachmentsHTML += `<div style="margin-top:6px;padding:8px 12px;background:rgba(255,255,255,0.08);border-radius:10px;display:flex;align-items:center;gap:8px;cursor:pointer" onclick="downloadFile('${attachment.url}', '${attachment.name || 'file'}')"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><div><p style="font-size:13px;opacity:0.9">${attachment.name || 'File'}</p><p style="font-size:11px;opacity:0.6">${attachment.size || ''}</p></div></div>`;
          } else if (attachment.type === 'voice') {
            attachmentsHTML += `<div style="margin-top:6px;display:flex;align-items:center;gap:8px"><button onclick="playVoiceNote('${attachment.url}')" style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.15);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="color:#fff"><path d="M8 5v14l11-7z"/></svg></button><div style="flex:1"><div style="height:3px;background:rgba(255,255,255,0.2);border-radius:2px"><div class="voice-progress" style="height:100%;background:rgba(255,255,255,0.6);width:0;border-radius:2px"></div></div><p style="font-size:11px;opacity:0.5;margin-top:3px">${attachment.duration || '00:00'}</p></div></div>`;
          }
        });
      }

      let replyHTML = '';
      if (replyTo && replyTo.username && replyTo.text) {
        replyHTML = `<div class="reply-quote"><div class="rq-user">${escapeHTML(replyTo.username)}</div><div class="rq-text">${escapeHTML(replyTo.text)}</div></div>`;
      }

      const timeStr = new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      const safeMsg = message ? escapeHTML(message) : '';
      const safeUser = escapeHTML(username);

      let actionsHTML = '';
      if (isMe && messageId) {
        actionsHTML = `
          <div class="msg-actions">
            <button onclick="startEditMessage(${messageId}, this)" title="Edit">
              <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
              Edit
            </button>
            <button class="delete-btn" onclick="deleteMessage(${messageId})" title="Delete">
              <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              Delete
            </button>
          </div>`;
      } else if (!isMe) {
        actionsHTML = `
          <div class="msg-actions left">
            <button onclick="setReply('${safeUser}', '${safeMsg.replace(/'/g, "\\\'")}')" title="Reply">
              <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a5 5 0 015 5v6M3 10l6 6M3 10l6-6"/></svg>
              Reply
            </button>
          </div>`;
      }

      messageDiv.innerHTML = `
        <div style="max-width:78%;position:relative" class="msg-bubble-wrap">
          ${!isMe ? `<p style="font-size:11px;color:#8E8E93;margin-bottom:2px;margin-left:4px">${safeUser}</p>` : ''}
          <div class="${isMe ? 'bubble-sent' : 'bubble-received'}">
            ${replyHTML}
            ${message ? `<p>${safeMsg}</p>` : ''}
            ${attachmentsHTML}
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin-top:2px;${isMe ? 'justify-content:flex-end' : ''};padding:0 4px">
            <p style="font-size:10px;color:#636366">${timeStr}</p>
            <button onclick="setReply('${safeUser}', '${safeMsg.replace(/'/g, "\\\'")}')" style="background:none;border:none;cursor:pointer;padding:2px;opacity:0;transition:opacity 0.15s" class="reply-btn">
              <svg width="14" height="14" fill="none" stroke="#636366" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a5 5 0 015 5v6M3 10l6 6M3 10l6-6"/></svg>
            </button>
          </div>
          ${actionsHTML}
        </div>
      `;

      messagesContainer.appendChild(messageDiv);
      // Smart scroll: only auto-scroll if user is near bottom
      if (isUserNearBottom) {
        messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
      } else {
        newMessageCount++;
        const btn = document.getElementById('new-messages-btn');
        btn.textContent = `\u2193 ${newMessageCount} new message${newMessageCount > 1 ? 's' : ''}`;
        btn.classList.add('active');
      }
    }

    /* ------------------------------
          ESCAPING HTML
    ------------------------------ */

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;",
        '"': "&quot;", "'": "&#39;"
      }[m]));
    }

    /* ------------------------------
          WEBSOCKET HANDLING
    ------------------------------ */

    socket.onmessage = async (e) => {
      const data = JSON.parse(e.data);

      /* ONLINE USERS LIST */
      if (data.type === "online_list") {
        onlineUsers = new Set(data.users);
        onlineUsers.delete(CURRENT_USER);
        document.getElementById('online-count').textContent = `${onlineUsers.size} user${onlineUsers.size !== 1 ? 's' : ''} online`;
        renderUserList();
        return;
      }

      if (data.type === "user_join") {
        onlineUsers.add(data.username);
        document.getElementById('online-count').textContent = `${onlineUsers.size} user${onlineUsers.size !== 1 ? 's' : ''} online`;
        renderUserList();
        return;
      }

      if (data.type === "user_leave") {
        onlineUsers.delete(data.username);
        document.getElementById('online-count').textContent = `${onlineUsers.size} user${onlineUsers.size !== 1 ? 's' : ''} online`;
        renderUserList();
        return;
      }

      /* TYPING INDICATOR */
      if (data.type === "typing") {
        showTypingIndicator(data.username);
        return;
      }

      /* ---------------- CALLING EVENTS ---------------- */

      if (data.type === "call_request") {
        if (data.target === CURRENT_USER) {
          showIncomingCall(data.from);
        }
        return;
      }

      if (data.type === "call_accept") {
        if (data.target === CURRENT_USER) {
          clearTimeout(ringTimeout);
          startAsCaller();
        }
        return;
      }

      if (data.type === "call_reject") {
        if (data.target === CURRENT_USER) {
          showNotification("Call was ended", "error");
          cleanupCall();
        }
        return;
      }

      if (data.type === "call_timeout") {
        if (data.target === CURRENT_USER) {
          showNotification("Call timed out", "warning");
          cleanupCall();
        }
        return;
      }

      if (data.type === "call_failed") {
        if (data.target === CURRENT_USER) {
          showNotification("Call failed", "error");
          cleanupCall();
        }
        return;
      }

      /* OFFER */
      if (data.type === "offer" && data.target === CURRENT_USER) {
        await handleOffer(data.offer, data.from);
        return;
      }

      /* ANSWER */
      if (data.type === "answer" && data.target === CURRENT_USER) {
        if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        return;
      }

      /* ICE */
      if (data.type === "ice" && data.target === CURRENT_USER) {
        if (pc && data.candidate) {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
          } catch (err) {
            console.warn("ICE add failed", err);
          }
        }
        return;
      }

      /* Normal chat message with attachments */
      if (data.message || data.attachments) {
        displayChatMessage(data.username, data.message, data.username === CURRENT_USER, data.attachments, data.reply_to || null, data.message_id || null);
        // Push notification if tab is hidden
        if (document.hidden && data.username !== CURRENT_USER && Notification.permission === 'granted') {
          new Notification(data.username, { body: data.message || 'Sent an attachment', icon: '/static/icons/icon-192.png' });
        }
      }

      /* Message edited */
      if (data.type === 'message_edited') {
        handleEditedMessage(data.message_id, data.content);
        return;
      }

      /* Message deleted */
      if (data.type === 'message_deleted') {
        handleDeletedMessage(data.message_id);
        return;
      }
    };

    /* ------------------------------
          NOTIFICATION SYSTEM
    ------------------------------ */

    function showNotification(message, type = "info") {
      const colors = {
        info: "bg-gray-800 border-gray-700",
        success: "bg-gray-800 border-gray-600",
        warning: "bg-gray-800 border-gray-600",
        error: "bg-gray-800 border-gray-700"
      };

      const notification = document.createElement('div');
      notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-gray-300 border px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce-in`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    /* ------------------------------
          ATTACHMENT HANDLING
    ------------------------------ */

    document.getElementById('attachment-btn').addEventListener('click', function (e) {
      const menu = document.getElementById('attachment-menu');
      menu.classList.toggle('hidden');
      e.stopPropagation();
    });

    document.addEventListener('click', function () {
      document.getElementById('attachment-menu').classList.add('hidden');
    });

    document.getElementById('file-upload').addEventListener('change', function (e) {
      const files = e.target.files;
      for (let file of files) {
        previewFile(file);
      }
      this.value = '';
    });

    document.getElementById('camera-upload').addEventListener('change', function (e) {
      const files = e.target.files;
      for (let file of files) {
        previewFile(file, true);
      }
      this.value = '';
    });

    async function uploadFileToServer(file, filename = null) {
      const formData = new FormData();
      formData.append('file', file, filename || file.name);
      formData.append('room', roomName);

      try {
        const response = await fetch('/media/upload/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });

        if (response.ok) {
          const data = await response.json();
          return data.url;
        } else {
          console.error('Upload failed:', response.statusText);
          return null;
        }
      } catch (error) {
        console.error('Upload error:', error);
        return null;
      }
    }

    async function previewFile(file, isCamera = false) {
      const previewContent = document.getElementById('media-preview-content');
      const previewContainer = document.getElementById('media-preview');

      // Upload file to server first
      const serverUrl = await uploadFileToServer(file);

      if (!serverUrl) {
        showNotification(`Failed to upload ${file.name}`, 'error');
        return;
      }

      const attachment = {
        file: file,
        url: serverUrl,
        type: file.type.startsWith('image/') ? 'image' : 'file',
        name: file.name,
        size: formatFileSize(file.size),
        isCamera: isCamera
      };

      attachments.push(attachment);

      const previewDiv = document.createElement('div');
      previewDiv.className = 'file-preview flex-shrink-0 w-20 h-20 relative';

      if (attachment.type === 'image') {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewDiv.innerHTML = `
            <img src="${e.target.result}" alt="${file.name}" class="w-full h-full object-cover rounded-lg border border-gray-700">
            <button onclick="removeAttachment(${attachments.length - 1})" class="absolute -top-1 -right-1 w-5 h-5 bg-gray-900 rounded-full border border-gray-700 flex items-center justify-center hover:bg-gray-800">
              <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          `;
          previewContent.appendChild(previewDiv);
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        previewDiv.innerHTML = `
          <div class="w-full h-full bg-gray-800 rounded-lg border border-gray-700 flex items-center justify-center">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <button onclick="removeAttachment(${attachments.length - 1})" class="absolute -top-1 -right-1 w-5 h-5 bg-gray-900 rounded-full border border-gray-700 flex items-center justify-center hover:bg-gray-800">
              <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        `;
        previewContent.appendChild(previewDiv);
        previewContainer.classList.remove('hidden');
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function removeAttachment(index) {
      attachments.splice(index, 1);
      updateMediaPreview();
    }

    function clearMediaPreview() {
      attachments = [];
      document.getElementById('media-preview').classList.add('hidden');
      document.getElementById('media-preview-content').innerHTML = '';
    }

    function updateMediaPreview() {
      const previewContent = document.getElementById('media-preview-content');
      const previewContainer = document.getElementById('media-preview');

      previewContent.innerHTML = '';

      if (attachments.length === 0) {
        previewContainer.classList.add('hidden');
        return;
      }

      attachments.forEach((attachment, index) => {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'file-preview flex-shrink-0 w-20 h-20 relative';

        if (attachment.type === 'image') {
          if (attachment.file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              previewDiv.innerHTML = `
                <img src="${e.target.result}" alt="${attachment.name}" class="w-full h-full object-cover rounded-lg border border-gray-700">
                <button onclick="removeAttachment(${index})" class="absolute -top-1 -right-1 w-5 h-5 bg-gray-900 rounded-full border border-gray-700 flex items-center justify-center hover:bg-gray-800">
                  <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              `;
              previewContent.appendChild(previewDiv);
            };
            reader.readAsDataURL(attachment.file);
          }
        } else {
          previewDiv.innerHTML = `
            <div class="w-full h-full bg-gray-800 rounded-lg border border-gray-700 flex items-center justify-center">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <button onclick="removeAttachment(${index})" class="absolute -top-1 -right-1 w-5 h-5 bg-gray-900 rounded-full border border-gray-700 flex items-center justify-center hover:bg-gray-800">
                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          `;
          previewContent.appendChild(previewDiv);
        }
      });

      previewContainer.classList.remove('hidden');
    }

    /* ------------------------------
          VOICE NOTE RECORDING
    ------------------------------ */

    document.getElementById('voice-note-btn').addEventListener('click', async function () {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        startVoiceRecording(stream);
      } catch (error) {
        console.error('Error accessing microphone:', error);
        showNotification('Cannot access microphone', 'error');
      }
    });

    function startVoiceRecording(stream) {
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];
      recordingSeconds = 0;

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: 'audio/webm' });

        // Upload voice note to server with proper filename
        const serverUrl = await uploadFileToServer(blob, 'voice_note.webm');

        if (!serverUrl) {
          showNotification('Failed to upload voice note', 'error');
          stream.getTracks().forEach(track => track.stop());
          return;
        }

        const attachment = {
          file: blob,
          url: serverUrl,
          type: 'voice',
          duration: formatTime(recordingSeconds),
          name: 'voice_note.webm',
          size: formatFileSize(blob.size)
        };

        attachments.push(attachment);
        updateMediaPreview();

        stream.getTracks().forEach(track => track.stop());
      };

      mediaRecorder.start();
      showVoiceRecordingUI();
      startRecordingTimer();
    }

    function showVoiceRecordingUI() {
      document.getElementById('voice-recording-ui').classList.remove('hidden');
    }

    function hideVoiceRecordingUI() {
      document.getElementById('voice-recording-ui').classList.add('hidden');
    }

    function startRecordingTimer() {
      clearInterval(recordingTimerInterval);
      recordingSeconds = 0;
      updateRecordingTimer();
      recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
    }

    function updateRecordingTimer() {
      recordingSeconds++;
      const m = String(Math.floor(recordingSeconds / 60)).padStart(2, "0");
      const s = String(recordingSeconds % 60).padStart(2, "0");
      document.getElementById("recording-timer").textContent = `${m}:${s}`;
    }

    document.getElementById('stop-recording').addEventListener('click', function () {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(recordingTimerInterval);
        hideVoiceRecordingUI();
        showNotification('Voice note recorded', 'success');
      }
    });

    function playVoiceNote(url) {
      const audio = new Audio(url);
      audio.play();
    }

    function formatTime(seconds) {
      const m = String(Math.floor(seconds / 60)).padStart(2, "0");
      const s = String(seconds % 60).padStart(2, "0");
      return `${m}:${s}`;
    }

    /* ------------------------------
          IMAGE PREVIEW FUNCTIONS
    ------------------------------ */

    function openImagePreview(url, name = 'image.jpg') {
      document.getElementById('preview-image').src = url;
      document.getElementById('image-preview-modal').classList.remove('hidden');
    }

    function closeImagePreview() {
      document.getElementById('image-preview-modal').classList.add('hidden');
      document.getElementById('preview-image').src = '';
    }

    /* ------------------------------
          FILE PREVIEW FUNCTIONS
    ------------------------------ */

    function openFilePreview(url, name) {
      document.getElementById('file-preview-title').textContent = name;
      document.getElementById('file-preview-iframe').src = url;
      document.getElementById('file-preview-modal').classList.remove('hidden');
    }

    function closeFilePreview() {
      document.getElementById('file-preview-modal').classList.add('hidden');
      document.getElementById('file-preview-iframe').src = '';
    }

    /* ------------------------------
          DOWNLOAD FUNCTION
    ------------------------------ */

    function downloadFile(url, name) {
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    /* ------------------------------
          SEND CHAT MESSAGE
    ------------------------------ */

    document.getElementById("chat-form").onsubmit = async (ev) => {
      ev.preventDefault();
      const inp = document.getElementById("message-input");
      const msg = inp.value.trim();

      if (!msg && attachments.length === 0) return;

      const messageData = {
        message: msg,
        attachments: attachments.map(att => ({
          type: att.type,
          name: att.name,
          size: att.size,
          duration: att.duration,
          url: att.url
        }))
      };

      // Include reply data if replying
      if (replyToData) {
        messageData.reply_to = { username: replyToData.username, text: replyToData.text };
        cancelReply();
      }

      (currentSocket || socket).send(JSON.stringify(messageData));

      // Clear attachments
      clearMediaPreview();
      inp.value = "";
      inp.focus();
    };

    /* ------------------------------
          USER LIST UI
    ------------------------------ */

    document.getElementById("call-icon").onclick = () => {
      renderUserList();
      document.getElementById("call-user-popup").classList.remove("hidden");
    };

    function closeUserPopup() {
      document.getElementById("call-user-popup").classList.add("hidden");
    }

    function renderUserList() {
      const ul = document.getElementById("user-list");
      ul.innerHTML = "";

      const users = Array.from(onlineUsers);

      if (users.length === 0) {
        ul.innerHTML = `
          <div class="text-center py-8">
            <div class="w-16 h-16 mx-auto mb-4 bg-gray-800 rounded-full flex items-center justify-center border border-gray-700">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
            <p class="text-gray-400">No other users online</p>
          </div>
        `;
        return;
      }

      users.forEach(u => {
        const li = document.createElement("li");
        li.className = "flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-800 cursor-pointer transition-colors border border-gray-800";
        li.onclick = () => initiateCall(u);

        li.innerHTML = `
          <div class="w-10 h-10 bg-gradient-to-r from-gray-700 to-gray-800 rounded-full flex items-center justify-center border border-gray-600">
            <span class="text-gray-300 font-bold">${u.charAt(0).toUpperCase()}</span>
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium text-white truncate">${u}</p>
            <p class="text-sm text-gray-400">Online</p>
          </div>
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        `;

        ul.appendChild(li);
      });
    }

    /* ------------------------------
         CALL INITIATION
    ------------------------------ */

    function initiateCall(username) {
      callTarget = username;
      closeUserPopup();

      console.log("Initiating call to:", username);
      socket.send(JSON.stringify({
        type: "call_request",
        target: username
      }));

      showNotification(`Calling ${username}...`, "info");

      ringTimeout = setTimeout(() => {
        console.log("Call timed out - no answer from:", username);
        showNotification("No answer", "warning");
        cleanupCall();
      }, 30000); // Increased timeout to 30 seconds
    }

    /* ------------------------------
         INCOMING CALL POPUP
    ------------------------------ */

    function showIncomingCall(from) {
      callTarget = from;
      clearTimeout(ringTimeout);

      document.getElementById("caller-name").textContent = from;
      document.getElementById("incoming-call-popup").classList.remove("hidden");

      // Play ringtone
      const ringtone = document.getElementById('ringtone');
      ringtone.currentTime = 0;
      ringtone.play().catch(console.error);

      ringTimeout = setTimeout(() => {
        console.log("Incoming call timed out for:", from);
        socket.send(JSON.stringify({
          type: "call_timeout",
          target: from
        }));
        cleanupCall();
        document.getElementById("incoming-call-popup").classList.add("hidden");
        ringtone.pause();
      }, 30000); // Match caller timeout
    }

    document.getElementById("accept-call").onclick = () => {
      document.getElementById("incoming-call-popup").classList.add("hidden");
      clearTimeout(ringTimeout);

      const ringtone = document.getElementById('ringtone');
      ringtone.pause();

      socket.send(JSON.stringify({
        type: "call_accept",
        target: callTarget
      }));
    };

    document.getElementById("reject-call").onclick = () => {
      document.getElementById("incoming-call-popup").classList.add("hidden");
      clearTimeout(ringTimeout);

      const ringtone = document.getElementById('ringtone');
      ringtone.pause();

      socket.send(JSON.stringify({
        type: "call_reject",
        target: callTarget
      }));

      cleanupCall();
    };

    /* ------------------------------
         CALLER — CREATE OFFER
    ------------------------------ */

    async function startAsCaller() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });

        setupPeerConnection();
        showCallUI(callTarget);

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.send(JSON.stringify({
          type: "offer",
          offer,
          target: callTarget
        }));
      } catch (error) {
        console.error("Error starting call:", error);
        showNotification("Failed to access microphone", "error");
        cleanupCall();
      }
    }

    /* ------------------------------
         RECEIVER — HANDLE OFFER
    ------------------------------ */

    async function handleOffer(offer, caller) {
      callTarget = caller;

      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });

        setupPeerConnection();
        showCallUI(caller);

        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        socket.send(JSON.stringify({
          type: "answer",
          answer,
          target: caller
        }));
      } catch (error) {
        console.error("Error handling offer:", error);
        showNotification("Failed to join call", "error");
        cleanupCall();
      }
    }

    /* ------------------------------
         AUDIO LEVEL MONITORING
    ------------------------------ */

    function startAudioMonitoring() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(localStream);
        source.connect(analyser);
        analyser.fftSize = 32;
      }

      if (audioInterval) clearInterval(audioInterval);

      audioInterval = setInterval(() => {
        if (!analyser) return;

        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        const level = Math.min(average / 128, 1);

        const audioLevel = document.getElementById('audio-level');
        if (audioLevel) {
          audioLevel.style.width = `${level * 100}%`;
        }
      }, 100);
    }

    function stopAudioMonitoring() {
      if (audioInterval) {
        clearInterval(audioInterval);
        audioInterval = null;
      }

      const audioLevel = document.getElementById('audio-level');
      if (audioLevel) {
        audioLevel.style.width = '0%';
      }
    }

    /* ------------------------------
         PEER CONNECTION SETUP
    ------------------------------ */

    function setupPeerConnection() {
      pc = new RTCPeerConnection(iceConfig);

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.ontrack = (ev) => {
        document.getElementById("remoteAudio").srcObject = ev.streams[0];
      };

      pc.onicecandidate = (ev) => {
        if (ev.candidate) {
          socket.send(JSON.stringify({
            type: "ice",
            candidate: ev.candidate,
            target: callTarget
          }));
        }
      };

      pc.onconnectionstatechange = () => {
        const statusEl = document.getElementById('call-status');
        if (statusEl) {
          statusEl.textContent = pc.connectionState.charAt(0).toUpperCase() + pc.connectionState.slice(1);
        }

        if (pc.connectionState === "connected") {
          startAudioMonitoring();
          showNotification("Call connected", "success");
        }

        if (pc.connectionState === "disconnected") {
          showNotification("Call connection lost, trying to reconnect...", "warning");
        }

        if (pc.connectionState === "failed" ||
          pc.connectionState === "closed") {
          stopAudioMonitoring();
          cleanupCall();
        }
      };
    }

    /* ------------------------------
         CALL UI MANAGEMENT
    ------------------------------ */

    function showCallUI(username) {
      document.getElementById("call-with").textContent = username;
      document.getElementById("active-call-ui").classList.remove("hidden");
      document.getElementById("minimized-call-ui").classList.add("hidden");
      document.getElementById("minimized-call-name").textContent = username;
      isCallMinimized = false;

      callSeconds = 0;
      updateCallTimer();
      callTimerInterval = setInterval(updateCallTimer, 1000);
    }

    function updateCallTimer() {
      callSeconds++;
      const m = String(Math.floor(callSeconds / 60)).padStart(2, "0");
      const s = String(callSeconds % 60).padStart(2, "0");
      const timerText = `${m}:${s}`;

      document.getElementById("call-timer").textContent = timerText;
      document.getElementById("minimized-call-timer").textContent = timerText;
    }

    function hideCallUI() {
      document.getElementById("active-call-ui").classList.add("hidden");
      document.getElementById("minimized-call-ui").classList.add("hidden");
      clearInterval(callTimerInterval);
      document.getElementById("call-timer").textContent = "00:00";
      isCallMinimized = false;
    }

    /* ------------------------------
         CALL CONTROL BUTTONS
    ------------------------------ */

    document.getElementById("end-call-btn").onclick = () => {
      socket.send(JSON.stringify({
        type: "call_reject",
        target: callTarget
      }));
      cleanupCall();
      showNotification("Call ended", "info");
    };

    document.getElementById("mute-btn").onclick = () => {
      if (localStream) {
        const track = localStream.getAudioTracks()[0];
        track.enabled = !track.enabled;

        const muteIcon = document.getElementById('mute-icon');
        const muteText = document.querySelector('#mute-btn span');

        if (!track.enabled) {
          muteIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />`;
          muteText.textContent = "Muted";
          showNotification("Microphone muted", "info");
        } else {
          muteIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />`;
          muteText.textContent = "Mute";
          showNotification("Microphone unmuted", "info");
        }
      }
    };

    document.getElementById("speaker-btn").onclick = () => {
      const remoteAudio = document.getElementById('remoteAudio');
      remoteAudio.muted = !remoteAudio.muted;

      const speakerText = document.querySelector('#speaker-btn span');
      if (remoteAudio.muted) {
        speakerText.textContent = "Muted";
        showNotification("Speaker muted", "info");
      } else {
        speakerText.textContent = "Speaker";
        showNotification("Speaker unmuted", "info");
      }
    };

    /* ------------------------------
         CALL MINIMIZE/RESTORE
    ------------------------------ */

    document.getElementById("minimize-call").onclick = () => {
      document.getElementById("active-call-ui").classList.add("hidden");
      document.getElementById("minimized-call-ui").classList.remove("hidden");
      isCallMinimized = true;
    };

    document.getElementById("restore-call").onclick = () => {
      document.getElementById("active-call-ui").classList.remove("hidden");
      document.getElementById("minimized-call-ui").classList.add("hidden");
      isCallMinimized = false;
    };

    /* ------------------------------
         CLEANUP CALL
    ------------------------------ */

    function cleanupCall() {
      if (pc) {
        pc.close();
        pc = null;
      }

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }

      callTarget = null;
      clearTimeout(ringTimeout);

      stopAudioMonitoring();

      const ringtone = document.getElementById('ringtone');
      ringtone.pause();

      hideCallUI();
    }

    /* ------------------------------
         CAMERA PREVIEW FUNCTIONS
    ------------------------------ */

    let cameraStream = null;

    async function openCameraPreview() {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });

        const video = document.getElementById('camera-video');
        video.srcObject = cameraStream;
        document.getElementById('camera-preview-modal').classList.remove('hidden');
      } catch (error) {
        console.error('Error accessing camera:', error);
        showNotification('Cannot access camera', 'error');
      }
    }

    function closeCameraPreview() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      document.getElementById('camera-preview-modal').classList.add('hidden');
    }

    document.getElementById('capture-btn').addEventListener('click', async function () {
      if (!cameraStream) return;

      const video = document.getElementById('camera-video');
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async (blob) => {
        const filename = `camera_photo_${Date.now()}.jpg`;
        const file = new File([blob], filename, { type: 'image/jpeg' });
        await previewFile(file, true);
        closeCameraPreview();
        showNotification('Photo captured', 'success');
      }, 'image/jpeg', 0.8);
    });

    /* ------------------------------
         WEBSOCKET RECONNECTION
    ------------------------------ */

    let reconnectAttempts = 0;
    let currentSocket = socket;

    function setupSocketHandlers(ws) {
      ws.onclose = () => {
        document.getElementById('reconnect-banner').classList.add('active');
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
        console.log(`WebSocket closed. Reconnecting in ${delay}ms (attempt ${reconnectAttempts})...`);
        setTimeout(attemptReconnect, delay);
      };
      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
      };
    }

    function attemptReconnect() {
      const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/chat/' + roomName + '/';
      const newSocket = new WebSocket(wsUrl);
      newSocket.onopen = () => {
        console.log('WebSocket reconnected!');
        reconnectAttempts = 0;
        document.getElementById('reconnect-banner').classList.remove('active');
        showNotification('Connection restored', 'success');
        // Re-wire the onmessage handler
        newSocket.onmessage = socket.onmessage;
        currentSocket = newSocket;
      };
      newSocket.onclose = () => {
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
        document.getElementById('reconnect-banner').textContent = `Reconnecting\u2026 (attempt ${reconnectAttempts})`;
        setTimeout(attemptReconnect, delay);
      };
      newSocket.onerror = (error) => console.error('WebSocket reconnect error:', error);
    }

    setupSocketHandlers(socket);

    /* ------------------------------
         INITIALIZATION
    ------------------------------ */

    window.addEventListener('beforeunload', () => {
      if (pc) {
        cleanupCall();
      }
    });

    // Focus input on load
    document.getElementById("message-input").focus();

    /* ------------------------------
         HEADER DROPDOWN MENU
    ------------------------------ */

    document.getElementById('header-menu-btn').addEventListener('click', function (e) {
      e.stopPropagation();
      const dropdown = document.getElementById('header-dropdown');
      dropdown.classList.toggle('show');
    });

    document.addEventListener('click', function (e) {
      const dropdown = document.getElementById('header-dropdown');
      if (!e.target.closest('#header-menu-btn') && !e.target.closest('#header-dropdown')) {
        dropdown.classList.remove('show');
      }
    });

    /* ------------------------------
         PWA SERVICE WORKER
    ------------------------------ */

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(() => { });
    }

    /* ------------------------------
         TYPING INDICATOR
    ------------------------------ */

    function showTypingIndicator(username) {
      const el = document.getElementById('typing-indicator');
      document.getElementById('typing-username').textContent = username;
      el.classList.add('active');
      // Scroll to show it
      if (isUserNearBottom) {
        const mc = document.getElementById('messages');
        mc.scrollTo({ top: mc.scrollHeight, behavior: 'smooth' });
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => el.classList.remove('active'), 2500);
    }

    // Send typing event on keypress (debounced)
    document.getElementById('message-input').addEventListener('input', () => {
      if (typingDebounce) return;
      typingDebounce = setTimeout(() => { typingDebounce = null; }, 500);
      const ws = currentSocket || socket;
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'typing' }));
      }
    });

    /* ------------------------------
         SMART SCROLL
    ------------------------------ */

    const messagesEl = document.getElementById('messages');
    messagesEl.addEventListener('scroll', () => {
      const threshold = 100;
      isUserNearBottom = (messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - threshold);
      if (isUserNearBottom) {
        newMessageCount = 0;
        document.getElementById('new-messages-btn').classList.remove('active');
      }
    });

    function scrollToBottom(smooth = false) {
      const mc = document.getElementById('messages');
      mc.scrollTo({ top: mc.scrollHeight, behavior: smooth ? 'smooth' : 'instant' });
      newMessageCount = 0;
      document.getElementById('new-messages-btn').classList.remove('active');
      isUserNearBottom = true;
    }

    // Scroll to bottom on initial load (instant, no animation)
    scrollToBottom(false);

    /* ------------------------------
         KEYBOARD SHORTCUTS
    ------------------------------ */

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close modals in priority order
        const modals = [
          'image-preview-modal', 'camera-preview-modal', 'file-preview-modal',
          'incoming-call-popup', 'call-user-popup'
        ];
        for (const id of modals) {
          const el = document.getElementById(id);
          if (el && !el.classList.contains('hidden')) {
            el.classList.add('hidden');
            // Camera cleanup
            if (id === 'camera-preview-modal' && typeof closeCameraPreview === 'function') closeCameraPreview();
            if (id === 'image-preview-modal') document.getElementById('preview-image').src = '';
            document.getElementById('message-input').focus();
            return;
          }
        }
        // Close dropdown
        document.getElementById('header-dropdown').classList.remove('show');
        document.getElementById('attachment-menu').classList.add('hidden');
      }
    });

    /* ------------------------------
         DRAG & DROP FILE UPLOAD
    ------------------------------ */

    let dragCounter = 0;
    const dropZone = document.getElementById('drop-zone');

    document.addEventListener('dragenter', (e) => {
      e.preventDefault();
      dragCounter++;
      if (e.dataTransfer.types.includes('Files')) {
        dropZone.classList.add('active');
      }
    });

    document.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dragCounter--;
      if (dragCounter <= 0) {
        dragCounter = 0;
        dropZone.classList.remove('active');
      }
    });

    document.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      dragCounter = 0;
      dropZone.classList.remove('active');
      if (e.dataTransfer.files.length > 0) {
        for (const file of e.dataTransfer.files) {
          previewFile(file);
        }
        showNotification(`${e.dataTransfer.files.length} file(s) added`, 'success');
      }
    });

    /* ------------------------------
         DATE DIVIDERS ON LOAD
    ------------------------------ */

    (function insertDateDividers() {
      const mc = document.getElementById('messages');
      const msgs = mc.querySelectorAll('.message-animation');
      let prevDate = null;

      msgs.forEach((msg) => {
        const timeEl = msg.querySelector('p[style*="font-size:10px"]');
        if (!timeEl) return;
        // Use the timestamp text to determine grouping (approximate)
        // For server-rendered messages, we'll use a data attribute approach
      });

      // Simple approach: insert a "Today" divider at the top if there are messages
      if (msgs.length > 0) {
        const divider = document.createElement('div');
        divider.className = 'date-divider';
        divider.innerHTML = '<span>Today</span>';
        mc.insertBefore(divider, msgs[0]);
      }
    })();

    /* ------------------------------
         REPLY FUNCTIONALITY
    ------------------------------ */

    function setReply(username, text) {
      replyToData = { username, text };
      document.getElementById('reply-bar-user').textContent = username;
      document.getElementById('reply-bar-text').textContent = text || 'Attachment';
      document.getElementById('reply-bar').classList.add('active');
      document.getElementById('message-input').focus();
    }

    function cancelReply() {
      replyToData = null;
      document.getElementById('reply-bar').classList.remove('active');
    }

    // Show reply button on hover
    document.getElementById('messages').addEventListener('mouseover', (e) => {
      const wrap = e.target.closest('.msg-bubble-wrap');
      if (wrap) {
        const btn = wrap.querySelector('.reply-btn');
        if (btn) btn.style.opacity = '1';
      }
    });
    document.getElementById('messages').addEventListener('mouseout', (e) => {
      const wrap = e.target.closest('.msg-bubble-wrap');
      if (wrap) {
        const btn = wrap.querySelector('.reply-btn');
        if (btn) btn.style.opacity = '0';
      }
    });

    /* ------------------------------
         EMOJI PICKER
    ------------------------------ */

    const emojiData = {
      smileys: ['\u{1F600}', '\u{1F603}', '\u{1F604}', '\u{1F601}', '\u{1F606}', '\u{1F605}', '\u{1F602}', '\u{1F923}', '\u{1F60A}', '\u{1F607}', '\u{1F642}', '\u{1F643}', '\u{1F609}', '\u{1F60C}', '\u{1F60D}', '\u{1F970}', '\u{1F618}', '\u{1F617}', '\u{1F619}', '\u{1F61A}', '\u{1F60B}', '\u{1F61B}', '\u{1F61C}', '\u{1F92A}', '\u{1F61D}', '\u{1F911}', '\u{1F917}', '\u{1F914}', '\u{1F910}', '\u{1F928}', '\u{1F610}', '\u{1F611}', '\u{1F636}', '\u{1F60F}', '\u{1F612}', '\u{1F644}', '\u{1F62C}', '\u{1F925}', '\u{1F60E}', '\u{1F913}'],
      people: ['\u{1F44B}', '\u{1F91A}', '\u{1F590}', '\u{270B}', '\u{1F596}', '\u{1F44C}', '\u{1F90F}', '\u{270C}', '\u{1F91E}', '\u{1F91F}', '\u{1F918}', '\u{1F919}', '\u{1F448}', '\u{1F449}', '\u{1F446}', '\u{1F595}', '\u{1F447}', '\u{261D}', '\u{1F44D}', '\u{1F44E}', '\u{270A}', '\u{1F44A}', '\u{1F91B}', '\u{1F91C}', '\u{1F44F}', '\u{1F64C}', '\u{1F450}', '\u{1F932}', '\u{1F91D}', '\u{1F64F}'],
      nature: ['\u{1F436}', '\u{1F431}', '\u{1F42D}', '\u{1F439}', '\u{1F430}', '\u{1F98A}', '\u{1F43B}', '\u{1F43C}', '\u{1F428}', '\u{1F42F}', '\u{1F981}', '\u{1F42E}', '\u{1F437}', '\u{1F438}', '\u{1F435}', '\u{1F648}', '\u{1F649}', '\u{1F64A}', '\u{1F412}', '\u{1F414}', '\u{1F427}', '\u{1F426}', '\u{1F985}', '\u{1F33B}', '\u{1F339}', '\u{1F33A}', '\u{1F337}', '\u{1F331}', '\u{1F343}', '\u{1F340}'],
      food: ['\u{1F34E}', '\u{1F34F}', '\u{1F350}', '\u{1F34A}', '\u{1F34B}', '\u{1F34C}', '\u{1F349}', '\u{1F347}', '\u{1F353}', '\u{1F348}', '\u{1F352}', '\u{1F351}', '\u{1F34D}', '\u{1F965}', '\u{1F96D}', '\u{1F354}', '\u{1F355}', '\u{1F32D}', '\u{1F32E}', '\u{1F32F}', '\u{1F37F}', '\u{1F9C1}', '\u{1F370}', '\u{1F36A}', '\u{1F369}', '\u{1F36B}', '\u{1F37B}', '\u{2615}', '\u{1F375}', '\u{1F376}'],
      activity: ['\u26BD', '\u{1F3C0}', '\u{1F3C8}', '\u26BE', '\u{1F3BE}', '\u{1F3D0}', '\u{1F3B1}', '\u{1F3D3}', '\u{1F3B8}', '\u{1F3B5}', '\u{1F3B6}', '\u{1F3A4}', '\u{1F3AE}', '\u{1F3AF}', '\u{1F3B2}', '\u{1F9E9}', '\u{1F3AD}', '\u{1F3A8}', '\u{1F3AC}', '\u{1F3A7}', '\u{1F3C6}', '\u{1F3C5}', '\u{1F947}', '\u{1F948}', '\u{1F949}'],
      objects: ['\u{1F4A1}', '\u{1F4F1}', '\u{1F4BB}', '\u{2328}', '\u{1F4F7}', '\u{1F4F9}', '\u{1F4FA}', '\u{1F4FB}', '\u{23F0}', '\u{1F4E7}', '\u{1F4AC}', '\u{1F4AD}', '\u{1F4A3}', '\u{1F4E6}', '\u{1F4CB}', '\u{1F4CC}', '\u{1F4CE}', '\u{1F511}', '\u{1F512}', '\u{1F513}', '\u{1F527}', '\u{1F528}', '\u{1F4B0}', '\u{1F48E}'],
      symbols: ['\u2764\uFE0F', '\u{1F9E1}', '\u{1F49B}', '\u{1F49A}', '\u{1F499}', '\u{1F49C}', '\u{1F5A4}', '\u{1F90D}', '\u{1F90E}', '\u{1F494}', '\u2763\uFE0F', '\u{1F495}', '\u{1F49E}', '\u{1F493}', '\u{1F497}', '\u{1F496}', '\u{1F498}', '\u{1F49D}', '\u{1F4AF}', '\u2705', '\u274C', '\u2B50', '\u{1F31F}', '\u{1F4A5}', '\u{1F4AB}']
    };

    const tabIcons = { smileys: '\u{1F600}', people: '\u{1F44B}', nature: '\u{1F431}', food: '\u{1F354}', activity: '\u26BD', objects: '\u{1F4A1}', symbols: '\u2764\uFE0F' };

    function initEmojiPicker() {
      const tabsEl = document.getElementById('emoji-tabs');
      Object.keys(emojiData).forEach((cat, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-tab' + (i === 0 ? ' active' : '');
        btn.setAttribute('data-cat', cat);
        btn.textContent = tabIcons[cat];
        btn.onclick = () => switchEmojiTab(cat);
        tabsEl.appendChild(btn);
      });
      renderEmojis('smileys');
    }

    function switchEmojiTab(cat) {
      document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.emoji-tab[data-cat="${cat}"]`).classList.add('active');
      renderEmojis(cat);
    }

    function renderEmojis(cat) {
      const grid = document.getElementById('emoji-grid');
      grid.innerHTML = '';
      (emojiData[cat] || []).forEach(e => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = e;
        btn.onclick = () => insertEmoji(e);
        grid.appendChild(btn);
      });
    }

    function insertEmoji(emoji) {
      const inp = document.getElementById('message-input');
      const start = inp.selectionStart;
      const end = inp.selectionEnd;
      inp.value = inp.value.substring(0, start) + emoji + inp.value.substring(end);
      inp.selectionStart = inp.selectionEnd = start + emoji.length;
      inp.focus();
    }

    document.getElementById('emoji-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('emoji-picker').classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('#emoji-picker') && !e.target.closest('#emoji-btn')) {
        document.getElementById('emoji-picker').classList.remove('active');
      }
    });

    initEmojiPicker();

    /* ------------------------------
         MESSAGE SEARCH
    ------------------------------ */

    document.getElementById('search-icon').addEventListener('click', () => {
      const bar = document.getElementById('search-bar');
      bar.classList.add('active');
      document.getElementById('search-input').focus();
    });

    function closeSearch() {
      document.getElementById('search-bar').classList.remove('active');
      document.getElementById('search-input').value = '';
      clearSearchHighlights();
      searchMatches = [];
      searchIndex = -1;
      document.getElementById('search-count').textContent = '';
    }

    function clearSearchHighlights() {
      document.querySelectorAll('.search-match').forEach(el => {
        el.classList.remove('search-match');
      });
    }

    let searchDebounce = null;
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => performSearch(e.target.value), 300);
    });

    function performSearch(query) {
      clearSearchHighlights();
      searchMatches = [];
      searchIndex = -1;

      if (!query.trim()) {
        document.getElementById('search-count').textContent = '';
        return;
      }

      const msgs = document.querySelectorAll('.message-animation');
      const q = query.toLowerCase();

      msgs.forEach(msg => {
        const text = (msg.getAttribute('data-text') || '').toLowerCase();
        if (text.includes(q)) {
          searchMatches.push(msg);
          msg.querySelector('.bubble-sent, .bubble-received').classList.add('search-match');
        }
      });

      if (searchMatches.length > 0) {
        searchIndex = 0;
        scrollToSearchMatch();
      }
      document.getElementById('search-count').textContent = searchMatches.length > 0 ? `${searchIndex + 1}/${searchMatches.length}` : 'No results';
    }

    function searchNav(dir) {
      if (searchMatches.length === 0) return;
      searchIndex = (searchIndex + dir + searchMatches.length) % searchMatches.length;
      scrollToSearchMatch();
      document.getElementById('search-count').textContent = `${searchIndex + 1}/${searchMatches.length}`;
    }

    function scrollToSearchMatch() {
      if (searchMatches[searchIndex]) {
        searchMatches[searchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    /* ------------------------------
         PUSH NOTIFICATIONS
    ------------------------------ */

    if ('Notification' in window && Notification.permission === 'default') {
      // Request permission after first user interaction
      document.addEventListener('click', function requestNotifPerm() {
        Notification.requestPermission();
        document.removeEventListener('click', requestNotifPerm);
      }, { once: true });
    }

    /* ------------------------------
         EDIT / DELETE MESSAGES
    ------------------------------ */

    function startEditMessage(msgId, btnEl) {
      const msgDiv = document.querySelector(`[data-msg-id="${msgId}"]`);
      if (!msgDiv) return;
      const bubble = msgDiv.querySelector('.bubble-sent, .bubble-received');
      if (!bubble) return;
      const pEl = bubble.querySelector('p');
      if (!pEl) return;

      const oldText = pEl.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = oldText;
      input.style.cssText = 'width:100%;background:#2C2C2E;border:1px solid #3A3A3C;border-radius:8px;padding:6px 10px;color:#fff;font-size:inherit;font-family:inherit;outline:none;';

      pEl.replaceWith(input);
      input.focus();
      input.select();

      function finishEdit() {
        const newText = input.value.trim();
        if (newText && newText !== oldText) {
          const ws = currentSocket || socket;
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'edit_message', message_id: msgId, content: newText }));
          }
        }
        // Restore the <p> regardless
        const newP = document.createElement('p');
        newP.textContent = newText || oldText;
        input.replaceWith(newP);
      }

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); finishEdit(); }
        if (e.key === 'Escape') { const p = document.createElement('p'); p.textContent = oldText; input.replaceWith(p); }
      });
      input.addEventListener('blur', finishEdit);
    }

    function deleteMessage(msgId) {
      if (!confirm('Delete this message?')) return;
      const ws = currentSocket || socket;
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'delete_message', message_id: msgId }));
      }
    }

    function handleEditedMessage(msgId, newContent) {
      const msgDiv = document.querySelector(`[data-msg-id="${msgId}"]`);
      if (!msgDiv) return;
      const bubble = msgDiv.querySelector('.bubble-sent, .bubble-received');
      if (!bubble) return;
      const pEl = bubble.querySelector('p');
      if (pEl) {
        pEl.textContent = newContent;
      }
      // Add (edited) tag if not already there
      if (!msgDiv.querySelector('.msg-edited-tag')) {
        const tag = document.createElement('span');
        tag.className = 'msg-edited-tag';
        tag.textContent = ' (edited)';
        const timeRow = msgDiv.querySelector('div[style*="display:flex"] > p');
        if (timeRow) timeRow.insertAdjacentElement('afterend', tag);
      }
      msgDiv.setAttribute('data-text', newContent);
    }

    function handleDeletedMessage(msgId) {
      const msgDiv = document.querySelector(`[data-msg-id="${msgId}"]`);
      if (!msgDiv) return;
      const bubble = msgDiv.querySelector('.bubble-sent, .bubble-received');
      if (!bubble) return;
      bubble.innerHTML = '<p class="msg-deleted">This message was deleted</p>';
      // Remove action buttons
      const actions = msgDiv.querySelector('.msg-actions');
      if (actions) actions.remove();
      msgDiv.setAttribute('data-text', '');
    }

  </script>

</body>

</html>